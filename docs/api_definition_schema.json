{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://xplatgen.dev/schemas/api-definition/v1",
  "title": "xplatgen API Definition",
  "description": "Schema for xplatgen API definition YAML files. Defines the API surface (handles, interfaces, methods) for cross-platform code generation. All data types (structs, enums, unions, constants) are defined in FlatBuffers schemas, not in this file.",
  "type": "object",
  "required": ["api", "flatbuffers", "interfaces"],
  "additionalProperties": false,
  "properties": {
    "api": {
      "$ref": "#/$defs/api_metadata"
    },
    "flatbuffers": {
      "type": "array",
      "description": "List of FlatBuffers schema file paths. Types from these files are referenced by fully-qualified FlatBuffers namespace.",
      "items": {
        "type": "string",
        "pattern": "\\.fbs$"
      },
      "minItems": 1
    },
    "handles": {
      "type": "array",
      "description": "Opaque handle definitions. Implementation-managed objects represented as typed void* at the C ABI level. Each handle follows create/destroy lifecycle semantics.",
      "items": {
        "$ref": "#/$defs/handle_definition"
      }
    },
    "interfaces": {
      "type": "array",
      "description": "Grouped collections of related methods. Each interface generates C ABI functions named <api_name>_<interface>_<method>.",
      "items": {
        "$ref": "#/$defs/interface_definition"
      },
      "minItems": 1
    }
  },

  "$defs": {

    "api_metadata": {
      "type": "object",
      "description": "API metadata.",
      "required": ["name", "version"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "API name. Used as a prefix in generated C ABI function names.",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "version": {
          "type": "string",
          "description": "Semantic version of the API.",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the API."
        }
      }
    },

    "handle_definition": {
      "type": "object",
      "description": "An opaque handle type. C ABI: typedef struct <name>_s* <name>_handle;",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Handle type name. PascalCase.",
          "pattern": "^[A-Z][a-zA-Z0-9]*$"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what this handle represents."
        }
      }
    },

    "interface_definition": {
      "type": "object",
      "description": "A group of related methods.",
      "required": ["name", "methods"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Interface name. snake_case. Used in C ABI function naming.",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of this interface group."
        },
        "methods": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/method_definition"
          },
          "minItems": 1
        }
      }
    },

    "method_definition": {
      "type": "object",
      "description": "A single API method. Generates a C ABI function: <api_name>_<interface>_<method>(...).",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Method name. snake_case.",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of this method. Include performance characteristics (e.g. 'hot path') where relevant."
        },
        "parameters": {
          "type": "array",
          "description": "Ordered list of input parameters.",
          "items": {
            "$ref": "#/$defs/parameter_definition"
          }
        },
        "returns": {
          "$ref": "#/$defs/return_definition"
        },
        "error": {
          "type": "string",
          "description": "FlatBuffers enum type used as the error return. When specified, the C ABI function returns this type and any return value becomes a final out-parameter pointer.",
          "$ref": "#/$defs/flatbuffer_type_pattern"
        }
      }
    },

    "parameter_definition": {
      "type": "object",
      "description": "A method parameter.",
      "required": ["name", "type"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Parameter name. snake_case.",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "type": {
          "type": "string",
          "description": "Parameter type. Can be a primitive (int8..uint64, float32, float64, bool), string, buffer<primitive>, handle:Name, or a FlatBuffers fully-qualified type (Namespace.Type).",
          "$ref": "#/$defs/parameter_type_pattern"
        },
        "transfer": {
          "type": "string",
          "description": "Transfer semantics. 'value': copied across boundary (default for primitives and handles). 'ref': caller owns, callee borrows immutably (const T*). 'ref_mut': caller owns, callee borrows mutably (T*).",
          "enum": ["value", "ref", "ref_mut"],
          "default": "value"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of this parameter."
        }
      }
    },

    "return_definition": {
      "type": "object",
      "description": "Method return value. When the method also has an 'error' field, this becomes a final out-parameter pointer in the C ABI.",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Return type. Can be a primitive (int8..uint64, float32, float64, bool), handle:Name, or a FlatBuffers fully-qualified type. Cannot be string or buffer<T> â€” use FlatBuffer result types for those.",
          "$ref": "#/$defs/return_type_pattern"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the return value."
        }
      }
    },

    "primitive_type": {
      "type": "string",
      "enum": [
        "int8", "int16", "int32", "int64",
        "uint8", "uint16", "uint32", "uint64",
        "float32", "float64",
        "bool"
      ]
    },

    "parameter_type_pattern": {
      "type": "string",
      "description": "Valid parameter types: primitives, string, buffer<primitive>, handle:Name, or FlatBuffers Namespace.Type.",
      "pattern": "^(int8|int16|int32|int64|uint8|uint16|uint32|uint64|float32|float64|bool|string|buffer<(int8|int16|int32|int64|uint8|uint16|uint32|uint64|float32|float64)>|handle:[A-Z][a-zA-Z0-9]*|[A-Z][a-zA-Z0-9]*(\\.[A-Z][a-zA-Z0-9]*)*)$"
    },

    "return_type_pattern": {
      "type": "string",
      "description": "Valid return types: primitives, handle:Name, or FlatBuffers Namespace.Type. string and buffer<T> are not allowed as return types.",
      "pattern": "^(int8|int16|int32|int64|uint8|uint16|uint32|uint64|float32|float64|bool|handle:[A-Z][a-zA-Z0-9]*|[A-Z][a-zA-Z0-9]*(\\.[A-Z][a-zA-Z0-9]*)*)$"
    },

    "flatbuffer_type_pattern": {
      "type": "string",
      "description": "A FlatBuffers fully-qualified type reference (e.g. Common.ErrorCode, Geometry.Transform3D).",
      "pattern": "^[A-Z][a-zA-Z0-9]*(\\.[A-Z][a-zA-Z0-9]*)*$"
    }
  }
}
